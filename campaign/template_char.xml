<?xml version="1.0" encoding="iso-8859-1"?>

<!-- 
  Please see the license.html file included with this distribution for 
  attribution and copyright information.
-->

<root>
	<template name="number_charskilltotal" merge="join">
		<number_linked>
			<frame name="fieldlight" offset="7,5,7,5" />
			<displaysign />
			<rollable />
			<hideonvalue>0</hideonvalue>
			<source><name>stat</name><op>+</op></source>
			<source><name>state</name><op>+</op></source>
			<source><name>...encumbrance.armormaxstatbonusactive</name></source>
			<source><name>...encumbrance.armorcheckpenalty</name><op>+</op></source>
			<source><name>ranks</name><op>+</op></source>
			<source><name>misc</name><op>+</op></source>
			<!-- this is here so that skill check penalties from encumbrance apply properly -->
			<script>
				function onSourceValue(source, sourcename)
					if sourcename == "ranks" then
						return math.floor(source.getValue());
					elseif sourcename == "...encumbrance.armorcheckpenalty" then
						local bMaxActive = sources["...encumbrance.armormaxstatbonusactive"].getValue();
						if bMaxActive &gt; 0 then
							return math.min(DB.getValue(window.getDatabaseNode(), "armorcheckmultiplier", 0) * source.getValue(), 0);
						end
						return 0;
					elseif sourcename == "state" then
						if DataCommon.isPFRPG() then
							local nodeWin = window.getDatabaseNode();
							if DB.getValue(nodeWin, "state", 0) == 1 then
								local nRanks = DB.getValue(nodeWin, "ranks", 0);
								if nRanks > 0 then
									return 3;
								end
							end
						end
						return 0;
					end

					return super.onSourceValue(source, sourcename);
				end

				function action(draginfo)
					local nodeWin = window.getDatabaseNode();
					if nodeWin then
						local rActor = ActorManager.getActor("pc", nodeWin.getChild("..."));
						ActionSkill.performPCRoll(draginfo, rActor, nodeWin);
					end
	
					return true;
				end
				
				function onDragStart(button, x, y, draginfo)
					return action(draginfo);
				end

				function onDoubleClick(x,y)	
					return action();
				end
			</script>
		</number_linked>
	</template>
</root>
